<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Phù thủy</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f4f8; margin: 0; padding: 20px; }
  h1 { text-align: center; }
  .container { display: flex; gap: 20px; flex-wrap: wrap; }
  .t-card { background: #ffffff; border-radius: 8px; padding: 10px; width: 300px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  .buoi { display: flex; align-items: center; justify-content: space-between; padding: 5px; border-radius: 5px; margin-bottom: 5px; font-weight: bold; color: #fff; transition: background 0.3s; }
  .xanh-duong { background-color: #93c5fd; } 
  .xanh-duong.active { background-color: #3B82F6; } 
  .do { background-color: #fca5a5; }
  .do.active { background-color: #EF4444; }
  .xanh-ngoc { background-color: #5eead4; }
  .xanh-ngoc.active { background-color: #14B8A6; }
  .tim { background-color: #d8b4fe; }
  .tim.active { background-color: #A855F7; }
  .vang { background-color: #fef08a; color: #fff; } 
  .vang.active { background-color: #FACC15; color: #fff; } 
  .xanh-la { background-color: #86efac; }
  .xanh-la.active { background-color: #22C55E; }

  input[type="number"] { width: 60px; }
  .summary { margin-top: 20px; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  button { margin-top: 10px; padding: 8px 12px; border: none; border-radius: 5px; background: #3B82F6; color: #fff; cursor: pointer; }
  .row { display:flex; gap:10px; align-items:center; margin-bottom:10px; }
  .statusBar { margin-bottom:12px; padding:8px 10px; background:#fff7ed; border:1px solid #fbbf24; border-radius:8px; font-size:14px;}
</style>
</head>
<body>

<h1>Phù thủy</h1>

<div id="authStatus" class="statusBar">Đang kiểm tra đăng nhập…</div>

<div style="margin-bottom:8px" class="row">
  <label style="margin-right:12px">Thuốc thử ánh sáng: <input type="number" id="thuocThu" value="0" min="0"></label>
  <label style="margin-right:12px">Thuốc tăng cường: <input type="number" id="thuocTangCuong" value="0" min="0"></label>
  <label>Thuốc may mắn: <input type="number" id="thuocMayMan" value="0" min="0"></label>
</div>

<div class="container" id="tContainer"></div>

<button id="btnCompute">Tính điểm và nâng tối ưu</button>

<div class="summary" id="summary">
  <h2>Bảng tổng kết</h2>
  <p id="summaryDetail"></p>
  <h3>Nâng từng bụi</h3>
  <ul id="suggestList"></ul>
</div>

<script type="module">
// ---------------- Firebase imports ----------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ---------------- CONFIG (THAY BẰNG CỦA BẠN) ----------------
const firebaseConfig = {
  apiKey: "YOUR_APIKEY",
  authDomain: "YOUR_AUTHDOMAIN",
  projectId: "YOUR_PROJECTID",
  storageBucket: "YOUR_STORAGEBUCKET",
  messagingSenderId: "YOUR_MSG_SENDER",
  appId: "YOUR_APPID"
};
// ----------------------------------------------------------

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
const db = getFirestore(app);

// ---------------- Original Witch data & UI render ----------------
const TData = {
  T1: {boost: 30, luck: 5},
  T2: {boost: 90, luck: 20},
  T3: {boost: 430, luck: 80},
  T4: {boost: 2110, luck: 400},
  T5: {boost: 10530, luck: 2000},
  T6: {boost: 52640, luck: 10000},
  T7: {boost: 263160, luck: 50000},
  T8: {boost: 1315790, luck: 250000},
  T9: {boost: 6578950, luck: 1250000}
};
const buoiColors = [
  {name:"Xanh Dương", class:"xanh-duong"},
  {name:"Đỏ", class:"do"},
  {name:"Xanh Ngọc", class:"xanh-ngoc"},
  {name:"Tím", class:"tim"},
  {name:"Vàng", class:"vang"},
  {name:"Xanh Lá", class:"xanh-la"}
];
const MAX_LEVEL = 20;

const tContainer = document.getElementById("tContainer");

// render T cards
for (let t in TData) {
  const tCard = document.createElement("div");
  tCard.className = "t-card";
  tCard.innerHTML = `<h3 style="margin:0 0 8px;font-size:15px">${t}</h3>`;
  buoiColors.forEach((b)=>{
    const buoiDiv = document.createElement("div");
    buoiDiv.className = `buoi ${b.class}`;
    buoiDiv.innerHTML = `
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" class="checkbox-buoi" data-t="${t}" data-buoi="${b.name}">
        ${b.name}
      </label>
      <input type="number" class="input-level" data-t="${t}" data-buoi="${b.name}" value="0" min="0" max="${MAX_LEVEL}" disabled>
    `;
    tCard.appendChild(buoiDiv);
  });
  tContainer.appendChild(tCard);
}

// wire checkbox <-> input
document.querySelectorAll(".checkbox-buoi").forEach(cb=>{
  cb.addEventListener("change", ()=>{
    const t = cb.dataset.t;
    const buoi = cb.dataset.buoi;
    const input = document.querySelector(`.input-level[data-t="${t}"][data-buoi="${buoi}"]`);
    input.disabled = !cb.checked;
    const parentDiv = cb.closest(".buoi");
    if(cb.checked){
      parentDiv.classList.add("active");
    } else {
      parentDiv.classList.remove("active");
      input.value = 0;
    }
    // autosave when toggle
    scheduleAutosave();
  });
});

// ----------------- Helpers -----------------
const el = id => document.getElementById(id);
const parse = inp => Math.max(0, Number(inp.value)||0);
const fmt = n => Number(n).toLocaleString("vi-VN");

// ----------------- Compute logic (kept) -----------------
function tinhToanComputeAndShow(){
  const thuocThu = parse(el("thuocThu"));
  const thuocTangCuong = parse(el("thuocTangCuong"));
  const thuocMayMan = parse(el("thuocMayMan"));

  let totalTCUsed=0, totalMMUsed=0;
  const suggestList = [];

  const inputs = Array.from(document.querySelectorAll(".input-level"));

  // Tính tổng thuốc dùng (dùng logic của bạn)
  inputs.forEach(inp => {
    const t = inp.dataset.t;
    const buoi = inp.dataset.buoi;
    const cb = document.querySelector(`.checkbox-buoi[data-t="${t}"][data-buoi="${buoi}"]`);
    if(!cb.checked) return;

    let level = parse(inp);
    if(level > MAX_LEVEL) level = MAX_LEVEL;

    const boost = TData[t].boost;
    const luck = TData[t].luck;

    const tcNeeded = boost * level;
    if(tcNeeded <= thuocTangCuong){
      totalTCUsed += tcNeeded;
    } else {
      totalTCUsed += Math.min(tcNeeded, thuocTangCuong);
    }

    let mmUsed = 0;
    if(level >=10){
      mmUsed = luck * (level - 9);
      totalMMUsed += Math.min(mmUsed, thuocMayMan);
    }
  });

  // Gợi ý nâng tối đa dựa trên thuốc ban đầu
  inputs.forEach(inp => {
    const t = inp.dataset.t;
    const buoi = inp.dataset.buoi;
    const cb = document.querySelector(`.checkbox-buoi[data-t="${t}"][data-buoi="${buoi}"]`);
    if(!cb.checked) return;

    let level = parse(inp);
    if(level > MAX_LEVEL) level = MAX_LEVEL;

    const boost = TData[t].boost;
    const luck = TData[t].luck;

    let maxExtraLevel = 0;
    let tempTC = parse(el("thuocTangCuong"));
    let tempMM = parse(el("thuocMayMan"));
    for(let l = level + 1; l <= MAX_LEVEL; l++){
      const tcReq = boost;
      const mmReq = (l >=10) ? luck : 0;
      if(tcReq <= tempTC && mmReq <= tempMM){
        tempTC -= tcReq;
        tempMM -= mmReq;
        maxExtraLevel++;
      } else break;
    }
    const suggestedLevel = level + maxExtraLevel;
    suggestList.push(`${t} - ${buoi}: hiện tại ${level} → gợi ý nâng tối đa ${suggestedLevel}`);
  });

  const diemTC = Math.round(totalTCUsed * 2.8);
  const diemMM = Math.round(totalMMUsed * 28);
  const diemThu = Math.round(thuocThu * 70);
  const tongDiem = diemTC + diemMM + diemThu;

  // Hiển thị
  el("summaryDetail").innerHTML = `
    Thuốc tăng cường: ${diemTC} điểm<br>
    Thuốc may mắn: ${diemMM} điểm<br>
    Thuốc thử ánh sáng: ${diemThu} điểm<br>
    <b>Tổng điểm: ${tongDiem}</b>
  `;
  const ul = el("suggestList");
  ul.innerHTML = "";
  suggestList.forEach(item=>{
    const li = document.createElement("li");
    li.textContent = item;
    ul.appendChild(li);
  });

  // Save totalPoints to Firestore (if logged in)
  if (typeof saveTotalPoints === "function") {
    saveTotalPoints(tongDiem).catch(e=>console.error("saveTotalPoints fail", e));
  }
}

// hook compute button
el("btnCompute").addEventListener("click", tinhToanComputeAndShow);

// ----------------- FIRESTORE: autosave / autoload -----------------
let currentUID = null;
let autosaveTimer = null;

// Build selected object: only checked bushes saved
function gatherSelectedForSave(){
  const result = {};
  const checked = Array.from(document.querySelectorAll(".checkbox-buoi:checked"));
  checked.forEach(cb => {
    const t = cb.dataset.t;
    const buoi = cb.dataset.buoi;
    const input = document.querySelector(`.input-level[data-t="${t}"][data-buoi="${buoi}"]`);
    const lvl = Math.max(0, Number(input.value)||0);
    if (!result[t]) result[t] = {};
    result[t][buoi] = lvl;
  });
  return result;
}

function gatherInputsForSave(){
  return {
    thuocThu: parse(el("thuocThu")),
    thuocTangCuong: parse(el("thuocTangCuong")),
    thuocMayMan: parse(el("thuocMayMan")),
    selected: gatherSelectedForSave()
  };
}

// debounce autosave
function scheduleAutosave(){
  if (!currentUID) return;
  if (autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(async ()=>{
    try {
      const payload = {
        inputs: gatherInputsForSave(),
        updatedAt: serverTimestamp()
      };
      const ref = doc(db, "accounts", currentUID, "tabsData", "witch");
      await setDoc(ref, payload, { merge: true });
      // console.log("witch autosaved");
    } catch(e){
      console.error("autosave error", e);
    }
  }, 700);
}

// attach input listeners
["thuocThu","thuocTangCuong","thuocMayMan"].forEach(id=>{
  el(id).addEventListener("input", scheduleAutosave);
});

document.querySelectorAll(".input-level").forEach(inp=>{
  inp.addEventListener("input", scheduleAutosave);
});
document.querySelectorAll(".checkbox-buoi").forEach(cb=>{
  cb.addEventListener("change", scheduleAutosave);
});

// load saved data for uid
async function loadWitchData(uid){
  try {
    const ref = doc(db, "accounts", uid, "tabsData", "witch");
    const snap = await getDoc(ref);
    if (!snap.exists()) return;
    const data = snap.data();
    if (!data) return;
    const inputs = data.inputs || {};
    el("thuocThu").value = inputs.thuocThu ?? el("thuocThu").value;
    el("thuocTangCuong").value = inputs.thuocTangCuong ?? el("thuocTangCuong").value;
    el("thuocMayMan").value = inputs.thuocMayMan ?? el("thuocMayMan").value;

    // clear all checkboxes/inputs first
    document.querySelectorAll(".checkbox-buoi").forEach(cb=>{
      cb.checked = false;
      const t = cb.dataset.t, buoi = cb.dataset.buoi;
      const input = document.querySelector(`.input-level[data-t="${t}"][data-buoi="${buoi}"]`);
      if (input) { input.value = 0; input.disabled = true; }
      const parentDiv = cb.closest(".buoi");
      parentDiv.classList.remove("active");
    });

    const sel = inputs.selected || {};
    for (const t in sel) {
      for (const buoi in sel[t]) {
        const cb = document.querySelector(`.checkbox-buoi[data-t="${t}"][data-buoi="${buoi}"]`);
        const input = document.querySelector(`.input-level[data-t="${t}"][data-buoi="${buoi}"]`);
        if (cb && input) {
          cb.checked = true;
          input.disabled = false;
          input.value = sel[t][buoi];
          const parentDiv = cb.closest(".buoi");
          parentDiv.classList.add("active");
        }
      }
    }

    // If saved totalPoints exists, show it in summary (only display)
    const tp = data.totalPoints;
    if (tp !== undefined && tp !== null) {
      el("summaryDetail").innerHTML = `<b>Tổng điểm (lần lưu trước): ${fmt(tp)}</b>`;
    }
  } catch(e){
    console.error("loadWitchData failed", e);
  }
}

// save totalPoints
async function saveTotalPoints(total){
  if (!currentUID) return;
  try {
    const ref = doc(db, "accounts", currentUID, "tabsData", "witch");
    await setDoc(ref, { totalPoints: Number(total), updatedAt: serverTimestamp() }, { merge: true });
  } catch(e){
    console.error("saveTotalPoints failed", e);
  }
}

// ----------------- Auth handling -----------------
function promptSignIn(){
  return signInWithPopup(auth, provider);
}

onAuthStateChanged(auth, async (user) => {
  const status = document.getElementById("authStatus");
  if (!user) {
    currentUID = null;
    status.innerHTML = `<button onclick="promptSignIn()">Đăng nhập</button> — đăng nhập để lưu & tải dữ liệu tài khoản.`;
    return;
  }
  currentUID = user.uid;
  status.innerText = `Đã đăng nhập: ${user.email} (UID: ${currentUID}) — dữ liệu Witch sẽ được tải tự động.`;
  // ensure a doc exists and then load saved data
  try {
    const baseRef = doc(db, "accounts", currentUID, "tabsData", "witch");
    const snap = await getDoc(baseRef);
    if (!snap.exists()) {
      // create minimal doc with current inputs
      const payload = { inputs: gatherInputsForSave(), totalPoints: 0, updatedAt: serverTimestamp() };
      await setDoc(doc(db, "accounts", currentUID, "tabsData", "witch"), payload, { merge: true });
    }
  } catch(e){ console.error("ensure witch doc failed", e); }
  await loadWitchData(currentUID);
});

// expose promptSignIn to global scope for inline onclick
window.promptSignIn = promptSignIn;
</script>

</body>
</html>
