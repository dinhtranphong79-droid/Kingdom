<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Level pháo</title>

<style>
body { font-family: sans-serif; background: #eef2f5; padding: 20px; }
.container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
.input-group { margin-bottom: 12px; }
input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #aaa; font-size:16px; }
button { width: 100%; min-height: 50px; padding: 12px; background: #2563eb; color: white; font-size: 18px; border-radius: 12px; border: none; cursor: pointer; margin-bottom: 8px; }
button:hover { filter: brightness(0.95); }
.result { margin-top: 20px; padding: 14px; background: #f8fafc; border-radius: 12px; border: 1px solid #ccc; word-break: break-word; }
pre.log { white-space: pre-wrap; font-family: monospace; }
h2 { margin-bottom: 16px; }
.statusBar { margin-bottom:12px; padding:8px 10px; background:#fff7ed; border:1px solid #fbbf24; border-radius:8px; font-size:14px;}
</style>
</head>

<body>
<div class="container">
  <h2>Level pháo</h2>
  <div id="status" class="statusBar">Đang kiểm tra tài khoản…</div>

  <div class="input-group"><label>Đá</label><input type="number" id="stone" value="0"></div>
  <div class="input-group"><label>Gỗ</label><input type="number" id="wood" value="0"></div>
  <div class="input-group"><label>Quặng</label><input type="number" id="ore" value="0"></div>
  <div class="input-group"><label>Hộp pháo</label><input type="number" id="boxes" value="0"></div>
  <div class="input-group"><label>Cấp mục tiêu</label><input type="number" id="targetLevel" placeholder="Để trống = tính tối đa"></div>

  <button id="btnCompute">Tính</button>
  <div id="output" class="result" style="display:none"></div>
</div>

<script type="module">
/* =====================================================
   DÙNG FIREBASE CHUNG TỪ index.html
   ===================================================== */



import {
  doc, getDoc, setDoc, runTransaction,
  addDoc, collection, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ================== UI ================== */
const $ = id => document.getElementById(id);
const statusEl = $('status');
const outputEl = $('output');


/* ================== STATE ================== */
  let auth = null;
let db   = null;

let uid=null, email=null, remaining=null;

/* ================== TÍNH TOÁN (GIỮ NGUYÊN LOGIC) ================== */
function toNum(id){ return Number($(id).value)||0; }
function simulateOptimal(S, W, Q, B, lv){
  const needStone = 1260 * lv;
  const needWood  = 340 * lv;
  const needOre   = 130 * lv;

  let log = [];

  /* 1️⃣ Hộp pháo */
  let boxForOre = Math.min(B, needOre - Q);
  if(boxForOre > 0){
    log.push({step:"Hộp → Quặng", detail:`${boxForOre} hộp → +${boxForOre} quặng`});
    Q += boxForOre; B -= boxForOre;
  }

  let boxForWood = Math.min(B, Math.ceil((needWood - W) / 4));
  if(boxForWood > 0){
    log.push({step:"Hộp → Gỗ", detail:`${boxForWood} hộp → +${boxForWood*4} gỗ`});
    W += boxForWood * 4; B -= boxForWood;
  }

  if(B > 0){
    log.push({step:"Hộp → Đá", detail:`${B} hộp → +${B*20} đá`});
    S += B * 20;
    B = 0;
  }

  /* 2️⃣ Quy đổi tài nguyên */
  while(true){
    let missOre  = Math.max(0, needOre - Q);
    let missWood = Math.max(0, needWood - W);

    let s2w = Math.min(Math.floor(S / 5), missWood + missOre * 4);
    if(s2w > 0){
      log.push({step:"Đá → Gỗ", detail:`${s2w*5} đá → +${s2w} gỗ`});
      S -= s2w * 5;
      W += s2w;
    }

    let w2o = Math.min(Math.floor(W / 4), missOre);
    if(w2o > 0){
      log.push({step:"Gỗ → Quặng", detail:`${w2o*4} gỗ → +${w2o} quặng`});
      W -= w2o * 4;
      Q += w2o;
    }

    if(s2w <= 0 && w2o <= 0) break;
  }

  if(S < needStone || W < needWood || Q < needOre){
    return { ok:false, log };
  }

  return {
    ok: true,
    log,
    remain: {
      S: S - needStone,
      W: W - needWood,
      Q: Q - needOre
    }
  };
}

function computeMax(S,W,Q,B){
  let lv = 0;
  let last = null;
  while(true){
    const r = simulateOptimal(S,W,Q,B,lv+1);
    if(!r.ok) break;
    lv++;
    last = r;
  }
  return { lv, result: last };
}



/* ================== FIRESTORE ================== */
async function loadAccount(user){
  uid=user.uid; email=user.email;
  const ref=doc(db,"accounts",uid);
  const snap=await getDoc(ref);
  if(!snap.exists()){
    await setDoc(ref,{
      email,
      targets:{ cannon:{remaining:0}},
      tabsData:{ cannon:{}},
      createdAt:serverTimestamp()
    });
    remaining=0;
  }else{
    remaining=snap.data()?.targets?.cannon?.remaining ?? 0;
  }
  statusEl.innerHTML=`Đăng nhập: <b>${email}</b> — Còn: <b>${remaining}</b>`;
}

async function deduct(level){
  const ref=doc(db,"accounts",uid);
  const applied=await runTransaction(db,async(tx)=>{
    const snap=await tx.get(ref);
    let r=snap.data().targets.cannon.remaining||0;
    let use=Math.min(r,level);
    tx.update(ref,{"targets.cannon.remaining":r-use});
    return use;
  });
  remaining-=applied;
  statusEl.innerHTML=`Đăng nhập: <b>${email}</b> — Còn: <b>${remaining}</b>`;
}
async function saveTotalPoints(tabName, points, log){
  const ref = doc(db, "accounts", uid, "tabsData", tabName);
  await setDoc(ref,{
    totalPoints: points,
    log: log,
    updatedAt: serverTimestamp()
  },{merge:true});
}




/* ================== EVENT ================== */
$('btnCompute').onclick = async () => {
  let S = toNum('stone'),
      W = toNum('wood'),
      Q = toNum('ore'),
      B = toNum('boxes');

  let t = $('targetLevel').value;

  let lv;
  let res;

  if (t) {
    lv = Number(t);
    res = simulateOptimal(S, W, Q, B, lv);
  } else {
    const r = computeMax(S, W, Q, B);
    lv = r.lv;
    res = r.result;
  }

  if (!res || !res.ok) {
    outputEl.style.display = "block";
    outputEl.innerHTML = `
      <b>❌ Không đủ tài nguyên để đạt cấp ${lv}</b><br><br>
      ${renderLogTable(res?.log)}
    `;
    return;
  }

  const points = lv * 556000;

  outputEl.style.display = "block";
  outputEl.innerHTML = `
    <b>Cấp đạt:</b> ${lv}<br>
    <b>Điểm:</b> ${points.toLocaleString("vi-VN")}<br><br>

    <b>Các bước quy đổi:</b>
    ${renderLogTable(res.log)}

    <br><b>Còn lại:</b>
    <ul>
      <li>Đá: ${res.remain.S}</li>
      <li>Gỗ: ${res.remain.W}</li>
      <li>Quặng: ${res.remain.Q}</li>
    </ul>
  `;

  if (uid) {
    await saveTotalPoints("cannon", points, res.log);
  }
};

/* ================== AUTH ================== */
function waitForAuth(){
  if (!window.parent.__FB || !window.parent.__FB.auth) {
    return setTimeout(waitForAuth, 50);
  }

  const FB = window.parent.__FB;
  auth = FB.auth;
  db   = FB.db;

  // ✅ FIX QUAN TRỌNG: nếu đã login từ trước thì load ngay
  if (auth.currentUser) {
    loadAccount(auth.currentUser);
  }

  // vẫn lắng nghe thay đổi về sau
  FB.onAuthStateChanged(auth, async user => {
    if (user) {
      await loadAccount(user);
    } else {
      statusEl.innerHTML = "❌ Chưa đăng nhập";
    }
  });
}

waitForAuth();

function renderLogTable(log){
  if(!log || log.length === 0) return "<i>Không có quy đổi</i>";

  let html = `
  <table style="width:100%;border-collapse:collapse;margin-top:10px">
    <tr style="background:#e5e7eb">
      <th style="border:1px solid #ccc;padding:6px">Bước</th>
      <th style="border:1px solid #ccc;padding:6px">Chi tiết</th>
    </tr>`;

  log.forEach(l=>{
    html += `
      <tr>
        <td style="border:1px solid #ccc;padding:6px">${l.step}</td>
        <td style="border:1px solid #ccc;padding:6px">${l.detail}</td>
      </tr>`;
  });

  html += "</table>";
  return html;
}



</script>
</body>
</html>
