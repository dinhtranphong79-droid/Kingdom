<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Level pháo</title>

<style>
body { font-family: sans-serif; background: #eef2f5; padding: 20px; }
.container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
.input-group { margin-bottom: 12px; }
input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #aaa; font-size:16px; }
button { width: 100%; min-height: 50px; padding: 12px; background: #2563eb; color: white; font-size: 18px; border-radius: 12px; border: none; cursor: pointer; margin-bottom: 8px; }
button:hover { filter: brightness(0.95); }
.result { margin-top: 20px; padding: 14px; background: #f8fafc; border-radius: 12px; border: 1px solid #ccc; word-break: break-word; }
pre.log { white-space: pre-wrap; font-family: monospace; }
h2 { margin-bottom: 16px; }
.statusBar { margin-bottom:12px; padding:8px 10px; background:#fff7ed; border:1px solid #fbbf24; border-radius:8px; font-size:14px;}
</style>
</head>

<body>
<div class="container">
  <h2>Level pháo</h2>
  <div id="status" class="statusBar">Đang kiểm tra tài khoản…</div>

  <div class="input-group"><label>Đá</label><input type="number" id="stone" value="0"></div>
  <div class="input-group"><label>Gỗ</label><input type="number" id="wood" value="0"></div>
  <div class="input-group"><label>Quặng</label><input type="number" id="ore" value="0"></div>
  <div class="input-group"><label>Hộp pháo</label><input type="number" id="boxes" value="0"></div>
  <div class="input-group"><label>Cấp mục tiêu</label><input type="number" id="targetLevel" placeholder="Để trống = tính tối đa"></div>

  <button id="btnCompute">Tính</button>
  <div id="output" class="result" style="display:none"></div>
</div>

<script type="module">
/* =====================================================
   DÙNG FIREBASE CHUNG TỪ index.html
   ===================================================== */



import {
  doc, getDoc, setDoc, runTransaction,
  addDoc, collection, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ================== UI ================== */
const $ = id => document.getElementById(id);
const statusEl = $('status');
const outputEl = $('output');


/* ================== STATE ================== */
  let auth = null;
let db   = null;

let uid=null, email=null, remaining=null;

/* ================== TÍNH TOÁN (GIỮ NGUYÊN LOGIC) ================== */
function toNum(id){ return Number($(id).value)||0; }

function simulateOptimal(S,W,Q,B,lv){
  const needStone=1260*lv, needWood=340*lv, needOre=130*lv;
  let log=[];
  let boxForOre=Math.min(B,needOre-Q); Q+=boxForOre; B-=boxForOre;
  let boxForWood=Math.min(B,Math.ceil((needWood-W)/4)); W+=boxForWood*4; B-=boxForWood;
  S+=B*20;

  while(true){
    let missOre=Math.max(0,needOre-Q);
    let missWood=Math.max(0,needWood-W);
    let s2w=Math.min(Math.floor(S/5),missWood+missOre*4);
    let w2o=Math.min(Math.floor(W/4),missOre);
    if(s2w<=0 && w2o<=0) break;
    S-=s2w*5; W+=s2w;
    W-=w2o*4; Q+=w2o;
  }

  if(S<needStone||W<needWood||Q<needOre) return {ok:false};
  return {ok:true, remain:{S:S-needStone,W:W-needWood,Q:Q-needOre}};
}

function computeMax(S,W,Q,B){
  let lv=0;
  while(simulateOptimal(S,W,Q,B,lv+1).ok) lv++;
  return lv;
}

/* ================== FIRESTORE ================== */
async function loadAccount(user){
  uid=user.uid; email=user.email;
  const ref=doc(db,"accounts",uid);
  const snap=await getDoc(ref);
  if(!snap.exists()){
    await setDoc(ref,{
      email,
      targets:{ cannon:{remaining:0}},
      tabsData:{ cannon:{}},
      createdAt:serverTimestamp()
    });
    remaining=0;
  }else{
    remaining=snap.data()?.targets?.cannon?.remaining ?? 0;
  }
  statusEl.innerHTML=`Đăng nhập: <b>${email}</b> — Còn: <b>${remaining}</b>`;
}

async function deduct(level){
  const ref=doc(db,"accounts",uid);
  const applied=await runTransaction(db,async(tx)=>{
    const snap=await tx.get(ref);
    let r=snap.data().targets.cannon.remaining||0;
    let use=Math.min(r,level);
    tx.update(ref,{"targets.cannon.remaining":r-use});
    return use;
  });
  remaining-=applied;
  statusEl.innerHTML=`Đăng nhập: <b>${email}</b> — Còn: <b>${remaining}</b>`;
}

/* ================== EVENT ================== */
$('btnCompute').onclick=async()=>{
  let S=toNum('stone'),W=toNum('wood'),Q=toNum('ore'),B=toNum('boxes');
  let t=$('targetLevel').value;
  let lv=t?Number(t):computeMax(S,W,Q,B);
  outputEl.style.display="block";
  outputEl.innerHTML=`<b>Cấp đạt:</b> ${lv}<br><b>Điểm:</b> ${lv*556000}`;
  if(uid) await deduct(lv);
};

/* ================== AUTH ================== */
function waitForAuth(){
  if (!window.parent.__FB || !window.parent.__FB.auth) {
    return setTimeout(waitForAuth, 50);
  }

  const FB = window.parent.__FB;

  auth = FB.auth;   // ✅ gán vào biến global
  db   = FB.db;

  FB.onAuthStateChanged(auth, async user => {
    if (user) {
      await loadAccount(user);
    } else {
      statusEl.innerHTML = "❌ Chưa đăng nhập";
    }
  });
}

waitForAuth();



</script>
</body>
</html>
