<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Level pháo</title>
<style>
body { font-family: sans-serif; background: #eef2f5; padding: 20px; }
.container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
.input-group { margin-bottom: 12px; }
input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #aaa; font-size:16px; }
button { width: 100%; min-height: 50px; padding: 12px; background: #2563eb; color: white; font-size: 18px; border-radius: 12px; border: none; cursor: pointer; margin-bottom: 8px; }
button:hover { filter: brightness(0.95); }
.result { margin-top: 20px; padding: 14px; background: #f8fafc; border-radius: 12px; border: 1px solid #ccc; word-break: break-word; }
pre.log { white-space: pre-wrap; font-family: monospace; }
h2 { margin-bottom: 16px; }

.statusBar {
    margin-bottom: 10px;
    padding: 10px;
    background: #fff7ed;
    border:1px solid #fbbf24;
    border-radius:10px;
    font-size:14px;
}
</style>
</head>
<body>

<div class="container">
<h2>Level pháo</h2>

<div id="status" class="statusBar">Đang kiểm tra tài khoản…</div>

<div class="input-group"><label>Đá</label><input type="number" id="stone" value="0" min="0"></div>
<div class="input-group"><label>Gỗ</label><input type="number" id="wood" value="0" min="0"></div>
<div class="input-group"><label>Quặng</label><input type="number" id="ore" value="0" min="0"></div>
<div class="input-group"><label>Hộp pháo</label><input type="number" id="boxes" value="0" min="0"></div>
<div class="input-group"><label>Cấp mục tiêu</label><input type="number" id="targetLevel" value="" min="1" placeholder="Để trống nếu muốn tính cấp tối đa"></div>

<button id="btnCompute">Tính</button>
<div id="output" class="result" style="visibility:hidden"></div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { 
    getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider 
} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
import { 
    getFirestore, doc, getDoc, setDoc, updateDoc, runTransaction, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

/* ---------------------------------------------------------
   1) FIREBASE CONFIG – BẠN PHẢI THAY BẰNG CONFIG THẬT
--------------------------------------------------------- */
const firebaseConfig = {
    apiKey: "XXXX",
    authDomain: "XXXX",
    projectId: "XXXX",
    storageBucket: "XXXX",
    messagingSenderId: "XXXX",
    appId: "XXXX"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

const provider = new GoogleAuthProvider();

let currentUID = null;
let cannonRemaining = 0;

/* ---------------------------------------------------------
   2) TỰ ĐỘNG LOGIN BẰNG POPUP NẾU CHƯA ĐĂNG NHẬP
--------------------------------------------------------- */
function loginIfNeeded() {
    if (!auth.currentUser) {
        signInWithPopup(auth, provider);
    }
}

/* ---------------------------------------------------------
   3) LOAD DỮ LIỆU PHÁO THEO UID
--------------------------------------------------------- */
async function loadCannonData(uid, email) {

    const docRef = doc(db, "accounts", uid);

    const snap = await getDoc(docRef);

    // Nếu chưa có document → tạo mới
    if (!snap.exists()) {
        let defaultTarget = 3000;

        if (email === "minhlanne@dolvar.app") defaultTarget = 3000;
        if (email === "dolvaraegis@dolvar.app")     defaultTarget = 5000;

        await setDoc(docRef, {
            email: email,
            cannonRemaining: defaultTarget,
            createdAt: serverTimestamp()
        });

        cannonRemaining = defaultTarget;
    } 
    else {
        cannonRemaining = snap.data().cannonRemaining ?? 3000;
    }

    document.getElementById("status").innerHTML =
        `Tài khoản: <b>${email}</b> — Mục tiêu còn lại: <b>${cannonRemaining}</b>`;
}

/* ---------------------------------------------------------
   4) AUTO-SAVE INPUT (khi người dùng nhập)
--------------------------------------------------------- */
async function autosaveInput() {
    if (!currentUID) return;

    const docRef = doc(db, "accounts", currentUID);

    await updateDoc(docRef, {
        cannonInput: {
            stone: Number(stone.value) || 0,
            wood: Number(wood.value) || 0,
            ore:  Number(ore.value) || 0,
            boxes: Number(boxes.value) || 0,
            target: targetLevel.value
        }
    });
}

["stone","wood","ore","boxes","targetLevel"].forEach(id => {
    document.getElementById(id).addEventListener("input", autosaveInput);
});

/* ---------------------------------------------------------
   5) TÍNH VÀ TRỪ MỤC TIÊU BẰNG TRANSACTION
--------------------------------------------------------- */
async function deductTarget(levelUp) {
    const docRef = doc(db, "accounts", currentUID);

    await runTransaction(db, async (tx) => {
        const snap = await tx.get(docRef);
        if (!snap.exists()) throw "Account missing";

        const prev = snap.data().cannonRemaining ?? 0;
        const applied = Math.min(prev, levelUp);
        const newRemaining = prev - applied;

        tx.update(docRef, {
            cannonRemaining: newRemaining,
            lastUsed: serverTimestamp()
        });

        cannonRemaining = newRemaining;

        document.getElementById("status").innerHTML =
            `Tài khoản: <b>${snap.data().email}</b> — Mục tiêu còn lại: <b>${newRemaining}</b>`;
    });
}

/* ---------------------------------------------------------
   6) LOGIC TÍNH GỐC – GIỮ NGUYÊN 100%
--------------------------------------------------------- */
function toNum(id){
    let v = Number(document.getElementById(id).value);
    return (isNaN(v) || v<0) ? 0 : v;
}

/* --- Simulate tối ưu: đá + gỗ + quặng + hộp pháo --- */
function simulateOptimal(S, W, Q, B, lv){
    let stone=S, wood=W, ore=Q, box=B, log=[];
    const needStone = 1260*lv;
    const needWood = 340*lv;
    const needOre = 130*lv;

    let boxForOre = Math.min(box, needOre - ore);
    if(boxForOre>0){
        log.push(`Dùng ${boxForOre} hộp → +${boxForOre} quặng`);
        ore += boxForOre; box -= boxForOre;
    }
    let boxForWood = Math.min(box, Math.ceil((needWood - wood)/4));
    if(boxForWood>0){
        log.push(`Dùng ${boxForWood} hộp → +${boxForWood*4} gỗ`);
        wood += boxForWood*4; box -= boxForWood;
    }
    if(box>0){
        log.push(`Dùng ${box} hộp → +${box*20} đá`);
        stone += box; box=0;
    }

    while(true){
        let missOre = Math.max(0, needOre - ore);
        let missWood = Math.max(0, needWood - wood);

        let stoneToWood = Math.min(Math.floor(stone/5), missWood + missOre*4);
        if(stoneToWood>0){
            log.push(`Đổi ${stoneToWood*5} đá → +${stoneToWood} gỗ`);
            stone -= stoneToWood*5; wood += stoneToWood;
        }

        let woodToOre = Math.min(Math.floor(wood/4), missOre);
        if(woodToOre>0){
            log.push(`Đổi ${woodToOre*4} gỗ → +${woodToOre} quặng`);
            wood -= woodToOre*4; ore += woodToOre;
        }

        if(stoneToWood===0 && woodToOre===0) break;
    }

    let missStone = Math.max(0, needStone - stone);
    let missWood = Math.max(0, needWood - wood);
    let missOre = Math.max(0, needOre - ore);
    if(missStone>0 || missWood>0 || missOre>0){
        return {ok:false, missing:{stone:missStone, wood:missWood, ore:missOre}, log:log};
    }

    stone -= needStone;
    wood -= needWood;
    ore -= needOre;

    return {ok:true, log, remaining:{stone, wood, ore}};
}

/* --- Tính cấp tối đa bằng binary search --- */
function computeMaxLv(S,W,Q,B){
    let lo=0, hi=20000, lastLog=[], lastRemaining=null;
    while(lo<hi){
        let mid = Math.floor((lo+hi+1)/2);
        let result = simulateOptimal(S,W,Q,B,mid);
        if(result.ok){
            lo = mid;
            lastLog = result.log;
            lastRemaining = result.remaining;
        } else {
            hi = mid-1;
        }
    }
    return {maxLv: lo, log: lastLog, remaining: lastRemaining};
}

/* ---------------------------------------------------------
   7) CLICK = TÍNH + TRỪ TARGET
--------------------------------------------------------- */
async function compute(){
    if (!currentUID) return loginIfNeeded();

    let S = toNum('stone'), W = toNum('wood'), Q = toNum('ore'), B = toNum('boxes');
    let targetInput = document.getElementById('targetLevel').value.trim();
    const out = document.getElementById('output');
    out.style.visibility='visible';

    let levelUp = 0;

    if(targetInput !== ""){
        let target = Math.max(1, Number(targetInput));
        let result = simulateOptimal(S,W,Q,B,target);
        if(result.ok){
            out.innerHTML=`<b>Có thể đạt cấp:</b> ${target}<br>
            <b>Tổng điểm:</b> ${target*556000}<br><br>
            <b>Các bước đổi:</b><br><pre class="log">${result.log.join('\n')}</pre><br>
            <b>Còn lại:</b><br>
            <ul><li>Đá: ${result.remaining.stone}</li>
            <li>Gỗ: ${result.remaining.wood}</li>
            <li>Quặng: ${result.remaining.ore}</li></ul>`;
            levelUp = target;
        } 
        else {
            let miss = result.missing;
            out.innerHTML=`<b>Không đủ tài nguyên để đạt cấp ${target}</b><br>
            <b>Còn thiếu:</b><br>
            <ul><li>Đá: ${miss.stone}</li>
            <li>Gỗ: ${miss.wood}</li>
            <li>Quặng: ${miss.ore}</li></ul>`;
            levelUp = 0;
        }
    } 
    else {
        let res = computeMaxLv(S,W,Q,B);
        if(res.remaining){
            out.innerHTML=`<b>Cấp tối đa:</b> ${res.maxLv}<br>
            <b>Tổng điểm:</b> ${res.maxLv*556000}<br><br>
            <b>Các bước đổi:</b><br><pre class="log">${res.log.join('\n')}</pre><br>
            <b>Còn lại:</b><br>
            <ul><li>Đá: ${res.remaining.stone}</li>
            <li>Gỗ: ${res.remaining.wood}</li>
            <li>Quặng: ${res.remaining.ore}</li></ul>`;
            levelUp = res.maxLv;
        } 
        else {
            out.innerHTML=`<b>Không đủ tài nguyên để nâng cấp</b>`;
            levelUp = 0;
        }
    }

    await deductTarget(levelUp);
}

document.getElementById('btnCompute').addEventListener('click', compute);

/* ---------------------------------------------------------
   8) LISTENER – TỰ LOAD DATA KHI LOGIN
--------------------------------------------------------- */
onAuthStateChanged(auth, async (user) => {
    if (!user) {
        document.getElementById("status").innerHTML =
            `<button onclick="loginIfNeeded()">Đăng nhập</button>`;
        return;
    }

    currentUID = user.uid;

    await loadCannonData(user.uid, user.email);
});
</script>

</body>
</html>
