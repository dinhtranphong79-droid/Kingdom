<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rồng</title>

<style>
:root{--bg:#f5f7fb;--card:#fff;--accent:#0f62fe;--muted:#6b7280}
*{box-sizing:border-box;font-family:Inter,Arial,sans-serif}
body{margin:0;background:var(--bg);padding:28px;display:flex;justify-content:center}
.wrap{width:100%;max-width:980px;background:#fff;border-radius:12px;padding:18px 20px;box-shadow:0 12px 40px rgba(2,6,23,.08)}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.card{background:#f8fbff;border-radius:10px;padding:12px;border:1px solid #e6f0ff}
label{font-size:13px;color:var(--muted)}
input{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #e6eef8}
.controls{display:flex;gap:10px;margin-top:12px}
button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
.secondary{background:#fff;color:#000;border:1px solid #ddd}
.result{margin-top:14px}
.small{font-size:13px;color:var(--muted)}
table{width:100%;border-collapse:collapse}
td,th{padding:6px 8px;font-size:14px}
.right{text-align:right;font-weight:700}
</style>
</head>

<body>
<div class="wrap">
<h1>Rồng</h1>

<div id="status" class="small">Đang kiểm tra đăng nhập…</div>

<div class="grid">
  <div class="card">
    <h3>Tài nguyên</h3>
    <label>B</label><input id="haveB" type="number" value="0">
    <label>A</label><input id="haveA" type="number" value="0">
    <label>SR</label><input id="haveSR" type="number" value="0">
    <label>SSR</label><input id="haveSSR" type="number" value="0">
  </div>

  <div class="card">
    <h3>Level</h3>
    <label>Đồng</label><input id="lvlDong" type="number" value="0">
    <label>Bạc</label><input id="lvlBac" type="number" value="0">
    <label>Vàng</label><input id="lvlVang" type="number" value="0">
    <label>Truyền Kỳ</label><input id="lvlTK" type="number" value="0">
    <label>Rồng</label><input id="lvlDragon" type="number" value="0">
  </div>
</div>

<div class="controls">
  <button id="compute">Tính</button>
  <button id="reset" class="secondary">Reset</button>
</div>

<div id="resultArea" class="result" style="display:none">
  <h3>Kết quả</h3>
  <table>
    <tr><td>Tổng điểm</td><td class="right" id="ptsTotal"></td></tr>
  </table>
</div>
</div>

<script type="module">
/* ================= FIREBASE CHUNG ================= */
const { auth, db, onAuthStateChanged } = window.__FB;
import { doc, getDoc, setDoc, serverTimestamp } from
  "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ================= STATE ================= */
let uid=null,email=null;
const $=id=>document.getElementById(id);

/* ================= LOAD / SAVE ================= */
async function loadData(){
  const ref=doc(db,"accounts",uid,"tabsData","dragon");
  const snap=await getDoc(ref);
  if(!snap.exists()) return;
  const d=snap.data()?.inputs||{};
  Object.keys(d).forEach(k=>$(k).value=d[k]);
}

async function autoSave(){
  if(!uid) return;
  const payload={
    inputs:{
      haveB:+haveB.value||0,
      haveA:+haveA.value||0,
      haveSR:+haveSR.value||0,
      haveSSR:+haveSSR.value||0,
      lvlDong:+lvlDong.value||0,
      lvlBac:+lvlBac.value||0,
      lvlVang:+lvlVang.value||0,
      lvlTK:+lvlTK.value||0,
      lvlDragon:+lvlDragon.value||0
    },
    updatedAt:serverTimestamp()
  };
  await setDoc(doc(db,"accounts",uid,"tabsData","dragon"),payload,{merge:true});
}

/* ================= AUTH ================= */
onAuthStateChanged(auth,async user=>{
  if(!user){
    status.innerHTML=`<button onclick="window.__FB.signInWithPopup(auth,window.__FB.provider)">Đăng nhập</button>`;
    return;
  }
  uid=user.uid; email=user.email;
  status.innerHTML=`Đăng nhập: <b>${email}</b>`;
  await loadData();
});

/* ================= TÍNH ĐIỂM ================= */
function compute(){
  const total =
    haveB.value*70 +
    haveA.value*700 +
    haveSR.value*7000 +
    haveSSR.value*14000;

  ptsTotal.textContent = total.toLocaleString("vi-VN");
  resultArea.style.display="block";
  autoSave();
}

/* ================= EVENTS ================= */
compute.onclick=compute;
reset.onclick=()=>{
  document.querySelectorAll("input").forEach(i=>i.value=0);
  resultArea.style.display="none";
  autoSave();
};
document.querySelectorAll("input").forEach(i=>i.oninput=autoSave);
</script>
</body>
</html>
